#!/bin/bash

# 定义颜色输出
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}正在开始配置 Root 登录权限...${NC}"

# 1. 获取当前使用 sudo 的原始用户名和家目录
# 这样脚本在 ubuntu, debian, centos 等不同默认用户名的系统上都能通用
if [ -n "$SUDO_USER" ]; then
    CURRENT_USER="$SUDO_USER"
    USER_HOME=$(getent passwd "$SUDO_USER" | cut -d: -f6)
else
    # 如果直接是 root 登录的，尝试默认回退到 ubuntu (兼容旧习惯)
    CURRENT_USER="ubuntu"
    USER_HOME="/home/ubuntu"
fi

echo -e "检测到当前执行用户为: ${GREEN}${CURRENT_USER}${NC}"

# 2. 备份 SSH 配置文件
if [ -f "/etc/ssh/sshd_config" ]; then
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
    echo -e "配置文件已备份至 /etc/ssh/sshd_config.bak"
else
    echo -e "${RED}错误：未找到 /etc/ssh/sshd_config 文件！${NC}"
    exit 1
fi

# 3. 修改配置允许 Root 登录
# 使用 sed 修改 PermitRootLogin 和 PasswordAuthentication (可选，如果需要密码登录请取消下面注释)
sed -i "s/^#\?PermitRootLogin.*/PermitRootLogin yes/g" /etc/ssh/sshd_config
sed -i "s/^#\?PubkeyAuthentication.*/PubkeyAuthentication yes/g" /etc/ssh/sshd_config

# 如果你也想开启密码登录，把下面这行的注释(#)去掉
# sed -i "s/^#\?PasswordAuthentication.*/PasswordAuthentication yes/g" /etc/ssh/sshd_config

echo -e "SSH 配置文件修改完成。"

# 4. 同步密钥 (关键步骤)
# 确保 root .ssh 目录存在
mkdir -p /root/.ssh
chmod 700 /root/.ssh

# 检查当前用户是否有密钥文件
if [ -f "${USER_HOME}/.ssh/authorized_keys" ]; then
    cat "${USER_HOME}/.ssh/authorized_keys" >> /root/.ssh/authorized_keys
    chmod 600 /root/.ssh/authorized_keys
    echo -e "${GREEN}成功将用户 ${CURRENT_USER} 的 SSH 密钥同步给 Root！${NC}"
else
    echo -e "${YELLOW}警告：用户 ${CURRENT_USER} 没有 authorized_keys 文件。Root 可能无法使用密钥登录。${NC}"
fi

# 5. 智能重启 SSH 服务 (修复你之前的报错)
# 检测系统服务名是 ssh 还是 sshd
echo -e "正在重启 SSH 服务..."

if systemctl list-unit-files | grep -q "^ssh.service"; then
    SERVICE_NAME="ssh"
elif systemctl list-unit-files | grep -q "^sshd.service"; then
    SERVICE_NAME="sshd"
else
    # 尝试盲猜
    if [ -f "/etc/init.d/ssh" ]; then
        SERVICE_NAME="ssh"
    else
        SERVICE_NAME="sshd"
    fi
fi

# 执行重启
if service "$SERVICE_NAME" restart; then
    echo -e "${GREEN}----------------------------------------${NC}"
    echo -e "${GREEN}搞定！SSH 服务 ($SERVICE_NAME) 已重启。${NC}"
    echo -e "${GREEN}现在你可以直接使用 root 账号登录了。${NC}"
    echo -e "${GREEN}----------------------------------------${NC}"
else
    echo -e "${RED}----------------------------------------${NC}"
    echo -e "${RED}服务重启失败，请检查系统日志。${NC}"
    echo -e "${RED}----------------------------------------${NC}"
fi
